<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mercado Veci</title>
  <style>
    body{font-family:Arial, sans-serif;margin:0;background:#f3f7f0}
    header{background:#4CAF50;color:#fff;padding:15px;text-align:center}
    nav{background:#388E3C;padding:10px;text-align:center}
    nav a{color:#fff;margin:0 10px;text-decoration:none}
    .container{padding:20px;max-width:980px;margin:auto}
    .card{background:#fff;padding:15px;margin:10px 0;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
    button{background:#4CAF50;color:#fff;padding:10px;border:none;border-radius:6px;cursor:pointer}
    button:hover{background:#45a049}
    form{background:#fff;padding:15px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.1);margin-bottom:20px}
    form input, form textarea{width:100%;padding:8px;margin:6px 0;border:1px solid #ccc;border-radius:6px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:640px){.row{grid-template-columns:1fr}}
    .muted{color:#666;font-size:.9em}
    .badge{display:inline-block;padding:2px 8px;border-radius:12px;background:#e7f6ea;color:#2e7d32;font-size:.8em;margin-left:6px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:940px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){.grid{grid-template-columns:1fr}}
    .thumb{width:100%;height:180px;object-fit:cover;border-radius:8px;margin-bottom:8px;background:#eee}
    .preview{width:120px;height:120px;object-fit:cover;border:1px dashed #aaa;border-radius:8px;display:block}
  </style>
</head>
<body>
<header>
  <h1>Mercado Veci</h1>
  <p>Conectando familias para vender, comprar o trocar localmente</p>
</header>

<nav>
  <a href="#">Inicio</a>
  <a href="#publicar">Publicar</a>
  <a href="#listado">Listado</a>
  <a href="#ayuda">Ayuda</a>
</nav>

<div class="container">
  <h2 id="publicar">Publicar un producto</h2>
  <form id="productForm">
    <div class="row">
      <div>
        <label>Nombre del producto</label>
        <input type="text" id="nombreProducto" required />
      </div>
      <div>
        <label>Precio (USD)</label>
        <input type="number" id="precioProducto" step="0.01" min="0" required />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Nombre del vendedor</label>
        <input type="text" id="nombreVendedor" required />
      </div>
      <div>
        <label>Teléfono (WhatsApp)</label>
        <input type="tel" id="telefono" placeholder="+593..." />
      </div>
    </div>

    <label>Descripción</label>
    <textarea id="descripcionProducto" rows="3" placeholder="Ej. horario, punto de entrega, trueque, etc."></textarea>

    <div class="row" style="align-items:center">
      <div>
        <label>Imagen (opcional)</label>
        <input type="file" id="imagen" accept="image/*" />
        <small class="muted">Se comprimirá para ahorrar datos.</small>
      </div>
      <div style="text-align:center">
        <img id="preview" class="preview" alt="Vista previa" />
      </div>
    </div>

    <button type="submit">Publicar</button>
    <span class="muted" id="status"></span>
  </form>

  <h2 id="listado">Productos publicados <span class="badge" id="count">0</span></h2>
  <div class="grid" id="productos"></div>

  <section id="ayuda" class="card">
    <h3>¿Cómo funciona?</h3>
    <ol class="muted">
      <li>Publica tu producto con el formulario (puedes adjuntar imagen).</li>
      <li>Se guarda en Google Sheets y la imagen en Drive (enlace público).</li>
      <li>Los compradores te contactan por WhatsApp o llamada.</li>
      <li>Si no hay internet, las publicaciones quedan guardadas localmente.</li>
    </ol>
  </section>
</div>

<footer style="background:#388E3C;color:#fff;text-align:center;padding:10px;margin-top:20px">
  © 2025 Mercado Veci — Hecho para familias ecuatorianas
</footer>

<script>
  // === CONFIG ===
  const WEB_APP_URL = "PASTE_YOUR_WEB_APP_URL_HERE"; // <-- pega aquí tu URL de Apps Script
  const LS_KEY = "mercadoveci_publicaciones_v2";

  const form = document.getElementById("productForm");
  const statusEl = document.getElementById("status");
  const contenedor = document.getElementById("productos");
  const countEl = document.getElementById("count");
  const fileInput = document.getElementById("imagen");
  const previewImg = document.getElementById("preview");

  let imageBase64 = ""; // dataURL comprimido

  fileInput.addEventListener("change", async () => {
    const file = fileInput.files?.[0];
    if (!file) { imageBase64 = ""; previewImg.src = ""; return; }
    imageBase64 = await fileToCompressedDataURL(file, 1000, 0.8); // max ancho 1000px, calidad 0.8
    previewImg.src = imageBase64;
  });

  function cargarLocal() {
    try {
      const raw = localStorage.getItem(LS_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch { return []; }
  }
  function guardarLocal(pub) {
    const data = cargarLocal();
    data.unshift(pub);
    localStorage.setItem(LS_KEY, JSON.stringify(data));
  }

  function render(publicaciones) {
    contenedor.innerHTML = "";
    countEl.textContent = publicaciones.length;
    publicaciones.forEach(p => {
      const card = document.createElement("div");
      card.className = "card";
      const src = p.imageUrl || p.imageBase64 || "";
      const wspLink = p.telefono
        ? `https://wa.me/${p.telefono.replace(/[^0-9+]/g, '')}?text=${encodeURIComponent("Hola, me interesa tu producto: " + p.producto)}`
        : "";

      card.innerHTML = `
        ${src ? `<img class="thumb" src="${src}" alt="${p.producto}">` : ``}
        <h3>${p.producto}</h3>
        <p class="muted"><strong>Vendedor:</strong> ${p.vendedor}</p>
        <p><strong>Precio:</strong> $${Number(p.precio).toFixed(2)}</p>
        <p>${p.descripcion || ""}</p>
        <div style="display:flex; gap:8px; margin-top:6px;">
          ${wspLink ? `<a href="${wspLink}" target="_blank"><button>WhatsApp</button></a>` : ""}
          ${p.telefono ? `<a href="tel:${p.telefono}"><button>Llamar</button></a>` : ""}
        </div>
      `;
      contenedor.appendChild(card);
    });
  }

  // Carga inicial (local) para rapidez
  render(cargarLocal());

  // Intentar cargar remoto
  (async function cargarRemoto() {
    if (!WEB_APP_URL || WEB_APP_URL.includes("PASTE_YOUR_WEB_APP_URL_HERE")) return;
    try {
      const res = await fetch(WEB_APP_URL);
      const data = await res.json();
      const local = cargarLocal();
      const key = p => [p.producto, p.vendedor, p.precio, p.imageUrl].join("|");
      const mapa = new Map([...local, ...data].map(x => [key(x), x]));
      const combinados = Array.from(mapa.values());
      render(combinados);
    } catch (e) {
      console.warn("No se pudo cargar remoto:", e);
    }
  })();

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    statusEl.textContent = "Guardando...";
    const pub = {
      producto: document.getElementById("nombreProducto").value.trim(),
      precio: document.getElementById("precioProducto").value.trim(),
      vendedor: document.getElementById("nombreVendedor").value.trim(),
      telefono: document.getElementById("telefono").value.trim(),
      descripcion: document.getElementById("descripcionProducto").value.trim(),
      imageBase64 // podría ser "", si no suben imagen
    };

    if (!pub.producto || !pub.precio || !pub.vendedor) {
      statusEl.textContent = "Completa producto, precio y vendedor.";
      return;
    }

    // Guardar local primero
    guardarLocal(pub);
    render(cargarLocal());
    form.reset();
    previewImg.src = "";
    imageBase64 = "";

    // Intentar enviar al backend
    if (!WEB_APP_URL || WEB_APP_URL.includes("PASTE_YOUR_WEB_APP_URL_HERE")) {
      statusEl.textContent = "Guardado local (configura la URL del backend para subir a Sheets/Drive).";
      return;
    }

    try {
      const res = await fetch(WEB_APP_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(pub)
      });
      const json = await res.json();
      if (json.ok) {
        statusEl.textContent = "Guardado en Sheets y la imagen en Drive ✅";
        // Opcional: refrescar del remoto para que tome la imageUrl pública
        setTimeout(async () => {
          const r = await fetch(WEB_APP_URL);
          const data = await r.json();
          const local = cargarLocal();
          const key = p => [p.producto, p.vendedor, p.precio, p.imageUrl].join("|");
          const mapa = new Map([...local, ...data].map(x => [key(x), x]));
          render(Array.from(mapa.values()));
        }, 800);
      } else {
        statusEl.textContent = "Guardado local (falló el backend).";
      }
    } catch (err) {
      console.error(err);
      statusEl.textContent = "Sin conexión: guardado local.";
    }
  });

  // Utilidad: comprimir imagen a dataURL (maxWidth px)
  function fileToCompressedDataURL(file, maxWidth = 1000, quality = 0.8) {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const scale = Math.min(1, maxWidth / img.width);
          const w = Math.round(img.width * scale);
          const h = Math.round(img.height * scale);
          const canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          // intenta JPEG; si el original es PNG con transparencia, igual funciona
          const dataUrl = canvas.toDataURL('image/jpeg', quality);
          resolve(dataUrl);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });
  }
</script>
</body>
</html>
